name: Create Release
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      check_duty:
        description: "Check duty"
        type: boolean
        default: false

jobs:
  duty-version-check:
    if: github.event_name == 'workflow_dispatch' && inputs.check_duty
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get canary-checker version
        id: canary_checker_version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq '.dependencies[] | select(.name == "canary-checker") | .version' chart/Chart.yaml

      - name: Get config-db version
        id: config_db_version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq '.dependencies[] | select(.name == "config-db") | .version' chart/Chart.yaml

      - name: Get mission-control version
        id: mission_control_version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq '.image.tag' chart/values.yaml

      - name: Get latest duty release
        id: duty
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_DUTY=$(gh release view --repo flanksource/duty --json tagName -q '.tagName')
          echo "latest_version=$LATEST_DUTY" >> $GITHUB_OUTPUT
          echo "Latest duty version: $LATEST_DUTY"

      - name: Check duty version in canary-checker
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.canary_checker_version.outputs.result }}"
          echo "Checking canary-checker at version $VERSION"
          # Fetch go.mod from the tag
          DUTY_VERSION=$(gh api repos/flanksource/canary-checker/contents/go.mod?ref=v$VERSION --jq '.content' | base64 -d | grep 'github.com/flanksource/duty' | head -1 | awk '{print $2}')
          echo "canary-checker uses duty $DUTY_VERSION"
          if [[ "$DUTY_VERSION" != "${{ steps.duty.outputs.latest_version }}" ]]; then
            echo "::error::canary-checker ($VERSION) uses duty $DUTY_VERSION but latest is ${{ steps.duty.outputs.latest_version }}"
            exit 1
          fi

      - name: Check duty version in config-db
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.config_db_version.outputs.result }}"
          echo "Checking config-db at version $VERSION"
          # Fetch go.mod from the tag
          DUTY_VERSION=$(gh api repos/flanksource/config-db/contents/go.mod?ref=v$VERSION --jq '.content' | base64 -d | grep 'github.com/flanksource/duty' | head -1 | awk '{print $2}')
          echo "config-db uses duty $DUTY_VERSION"
          if [[ "$DUTY_VERSION" != "${{ steps.duty.outputs.latest_version }}" ]]; then
            echo "::error::config-db ($VERSION) uses duty $DUTY_VERSION but latest is ${{ steps.duty.outputs.latest_version }}"
            exit 1
          fi

      - name: Check duty version in mission-control
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.mission_control_version.outputs.result }}"
          echo "Checking mission-control (incident-commander) at version $VERSION"
          # Fetch go.mod from the tag
          DUTY_VERSION=$(gh api repos/flanksource/incident-commander/contents/go.mod?ref=$VERSION --jq '.content' | base64 -d | grep 'github.com/flanksource/duty' | head -1 | awk '{print $2}')
          echo "mission-control uses duty $DUTY_VERSION"
          if [[ "$DUTY_VERSION" != "${{ steps.duty.outputs.latest_version }}" ]]; then
            echo "::error::mission-control ($VERSION) uses duty $DUTY_VERSION but latest is ${{ steps.duty.outputs.latest_version }}"
            exit 1
          fi

  stable-dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Check if chart has any beta dependencies
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: |
            RESULT=$(yq '[.dependencies[].version] | any_c(contains("beta"))' chart/Chart.yaml agent-chart/Chart.yaml)
            if [[ $RESULT =~ "true" ]]; then
              echo "Charts contain beta dependencies"
              exit 1
            fi

  semantic-release:
    runs-on: ubuntu-latest
    needs: [stable-dependency-check, duty-version-check]
    if: |
      always() &&
      needs.stable-dependency-check.result == 'success' &&
      (needs.duty-version-check.result == 'success' || needs.duty-version-check.result == 'skipped')
    outputs:
      release-version: ${{ steps.semantic.outputs.release-version }}
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set branch variable for semantic release
        run: |
          if [[ ${{ github.event_name == 'workflow_dispatch' }} == true ]]; then
            BRANCHES="['main']"
          else
            BRANCHES="[{name: 'main', channel: 'beta', prerelease: 'beta'}, {name: 'dummy-release'}]"
          fi
          echo "BRANCHES=$BRANCHES" >> $GITHUB_ENV
      - uses: codfish/semantic-release-action@cbd853afe12037afb1306caca9d6b1ab6a58cf2a # v1.10.0
        id: semantic
        with:
          branches: ${{ env.BRANCHES }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  helm:
    runs-on: ubuntu-latest
    needs: semantic-release
    if: always() 
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set version
        run: |
          git fetch --prune --unshallow
          echo "RELEASE_VERSION=$(git describe --abbrev=0 --tags | sed -e 's/^v//')" >> $GITHUB_ENV
      - name: Update chart version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.version = "${{ env.RELEASE_VERSION }}"' chart/Chart.yaml
      - name: Update app version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.appVersion = "${{ env.RELEASE_VERSION }}"' chart/Chart.yaml
      - name: Update agent chart version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.version = "${{ env.RELEASE_VERSION }}"' agent-chart/Chart.yaml
      - name: Update agent app version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.appVersion = "${{ env.RELEASE_VERSION }}"' agent-chart/Chart.yaml
      - name: Update crd app version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.appVersion = "${{ env.RELEASE_VERSION }}"' crd-chart/Chart.yaml
      - name: Update crd chart version
        uses: mikefarah/yq@7ccaf8e700ce99eb3f0f6cef7f5930a0b3c827cd # v4.49.2
        with:
          cmd: yq -i '.version = "${{ env.RELEASE_VERSION }}"' crd-chart/Chart.yaml

      - name: Set up Helm
        uses: azure/setup-helm@18bc76811624f360dbd7f18c2d4ecb32c7b87bab # v1.1
        with:
          version: v3.8.0
      - name: Package Helm chart
        run: |
          # New charts might not be immediately available
          sleep 60
          make chart agent-chart crd-chart
      - name: Clone charts repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: "${{ github.repository_owner }}/charts"
          path: charts
          token: "${{ secrets.FLANKBOT }}"
      - name: Update chart repo
        run: |
          cd charts
          cp ../mission-control-*.tgz ./
          helm repo index --merge index.yaml .
      - name: Push changes to chart repo
        uses: stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a # v4.16.0
        with:
          commit_message: "Release ${{ env.RELEASE_VERSION }} of ${{ github.repository }}"
          branch: gh-pages
          repository: ./charts
